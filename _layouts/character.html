---
layout: default
---

<div class="character-detail">
  <!-- Back Button Container for Centering -->
  <div class="back-btn-container" style="text-align: center; margin-bottom: 1rem;">
    <button class="back-select-btn" onclick="window.history.back();">
      Back to Character Selection
    </button>
  </div>
  
  <div class="detail-container">
    <!-- Left Panel: Character Background/Abilities -->
    <div class="left-panel">
      {{ content }}
    </div>

    <!-- Right Panel: Character Image and Basic Info -->
    <div class="right-panel">
      <div class="image-container">
        <!-- Clickable profile image (opens lightbox if gallery exists; PFP is NOT in the slideshow) -->
        <img id="profile-image"
             src="{{ page.image | relative_url }}"
             alt="{{ page.title | escape }}"
             style="cursor: zoom-in; max-width: 100%; height: auto;">
      </div>

      <div class="basic-info">
        {% if page.age %}<p><strong>Age:</strong> {{ page.age }}</p>{% endif %}
        {% if page.birthday %}<p><strong>Birthday:</strong> {{ page.birthday }}</p>{% endif %}
        {% if page.species %}<p><strong>Species:</strong> {{ page.species }}</p>{% endif %}
        {% if page.gender %}<p><strong>Gender:</strong> {{ page.gender }}</p>{% endif %}
        {% if page.height %}<p><strong>Height:</strong> {{ page.height }}</p>{% endif %}
        {% if page.weight %}<p><strong>Weight:</strong> {{ page.weight }}</p>{% endif %}
        {% if page.cup_size %}<p><strong>Cup Size:</strong> {{ page.cup_size }}</p>{% endif %}
        {% if page.mana_color %}<p><strong>Mana Color:</strong> {{ page.mana_color }}</p>{% endif %}
        {% if page.hair_color %}<p><strong>Hair color:</strong> {{ page.hair_color }}</p>{% endif %}
        {% if page.eye_color %}<p><strong>Eye color:</strong> {{ page.eye_color }}</p>{% endif %}
        {% if page.credit %}<p><strong>Picture Credit:</strong> {{ page.credit }}</p>{% endif %}
      </div>
    </div>
  </div>
</div>

{%- comment -%}
Lightbox items come ONLY from page.gallery (profile image is not included).
Supports short form (string) and object form {src, alt}.
{%- endcomment -%}
{% assign gallery = page.gallery %}
<script>
  window.__characterLightboxItems = [
    {% if gallery and gallery.size > 0 %}
      {% for item in gallery %}
        {
          {% if item.src %}
            "src": "{{ item.src | relative_url }}",
            "alt": {{ (item.alt | default: page.title) | jsonify }}
          {% else %}
            "src": "{{ item | relative_url }}",
            "alt": {{ page.title | jsonify }}
          {% endif %}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    {% endif %}
  ];
</script>

<!-- LIGHTBOX MARKUP -->
<div id="lb" class="lb" aria-hidden="true">
  <div class="lb-backdrop" data-close></div>

  <div class="lb-shell" role="dialog" aria-modal="true" aria-label="Image viewer" tabindex="-1">
    <!-- consistent, larger, lower stage -->
    <div class="lb-stage" id="lb-stage">
      <div class="lb-spinner" id="lb-spinner" aria-hidden="true"></div>

      <!-- transform layer for zoom/pan inside fixed stage -->
      <div id="lb-layer" aria-hidden="true">
        <img id="lb-img" src="" alt="" draggable="false" />
      </div>

      <!-- controls locked to stage edges -->
      <button class="lb-btn lb-prev" data-prev aria-label="Previous">&#10094;</button>
      <button class="lb-btn lb-next" data-next aria-label="Next">&#10095;</button>
      <button class="lb-btn lb-close" data-close aria-label="Close">&times;</button>
    </div>

    <div class="lb-captionbar">
      <figcaption id="lb-caption" class="lb-caption"></figcaption>
    </div>
  </div>
</div>

<style>
  /* ===== base ===== */
  .lb, .lb * { box-sizing: border-box; }
  .lb { position: fixed; inset: 0; display: none; z-index: 1000; }
  .lb[aria-hidden="false"] { display: block; }
  .lb-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.72); backdrop-filter: blur(2px); }

  /* shell: centers content, but pushes it further down */
  .lb-shell {
    position: absolute; inset: 0;
    display: grid;
    place-items: start center;      /* center horizontally, top vertically */
    padding:
      calc(env(safe-area-inset-top, 0px) + 10vh)   /* push down ~10vh */
      12px
      calc(env(safe-area-inset-bottom, 0px) + 12px);
  }

  /* ===== CONSISTENT STAGE SIZE =====
     ~20% wider than before: up to 1440px (was 1200px), and more vertical space.
     Desktop: width = min(100vw, 1440px), height = 82vh
  */
  .lb-stage {
    position: relative;
    width: min(100vw, 1440px);
    height: 82vh;                   /* big vertical space */
    background: rgba(0,0,0,.25);
    border-radius: .6rem;
    box-shadow: 0 16px 40px rgba(0,0,0,.45);
    overflow: hidden;
    display: grid; place-items: center;
  }

  /* image layer: fixed to the stage size; image fits (contain) */
  #lb-layer {
    width: 100%; height: 100%;
    display: grid; place-items: center;
    transform: translate(0px, 0px) scale(1);
    transform-origin: center center;
    will-change: transform;
    touch-action: none;
  }

  #lb-img {
    width: 100%;
    height: 100%;
    object-fit: contain;            /* <= fit best, keep aspect; empty side space for tall imgs */
    opacity: 0; transition: opacity .12s ease;
    user-select: none; -webkit-user-drag: none;
    pointer-events: none;           /* stage handles interactions */
  }

  /* caption under stage, fixed width matching stage */
  .lb-captionbar {
    width: min(100vw, 1440px);
    margin-top: .6rem;
    display: grid; place-items: center;
  }
  .lb-caption {
    color: #fff; width: 100%;
    font-size: .95rem; text-align: left;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    min-height: 1.2em;
  }

  /* controls anchored to stage */
  .lb-btn {
    position: absolute;
    background: rgba(0,0,0,.55);
    color: #fff; border: none; border-radius: 999px;
    width: 48px; height: 48px; display: grid; place-items: center;
    font-size: 22px; cursor: pointer; transition: background .15s ease;
    z-index: 2;
  }
  .lb-btn:hover { background: rgba(0,0,0,.8); }
  .lb-prev { left: 14px; top: 50%; transform: translateY(-50%); }
  .lb-next { right: 14px; top: 50%; transform: translateY(-50%); }
  .lb-close { top: 12px; right: 12px; width: 40px; height: 40px; font-size: 28px; background: rgba(0,0,0,.7); }

  /* spinner */
  .lb-spinner { position: absolute; inset: 0; display: grid; place-items: center; }
  .lb-spinner::after {
    content: ""; width: 38px; height: 38px; border-radius: 999px;
    border: 3px solid rgba(255,255,255,.35); border-top-color: #fff;
    animation: lbspin 0.8s linear infinite;
  }
  [aria-hidden="true"] > .lb-spinner, .lb-spinner[aria-hidden="true"] { display: none; }
  @keyframes lbspin { to { transform: rotate(360deg); } }

  /* mobile: full width stage, tall height, still pushed down a bit */
  @media (max-width: 720px) {
    .lb-shell {
      padding-top: calc(env(safe-area-inset-top, 0px) + 6vh); /* still lower than center */
      padding-left: 0; padding-right: 0;
    }
    .lb-stage { width: 100vw; height: 85vh; border-radius: 0; box-shadow: none; }
    .lb-captionbar { width: 100vw; padding: 0 10px; }
    .lb-btn { width: 56px; height: 56px; font-size: 24px; }
    .lb-close { width: 44px; height: 44px; font-size: 28px; }
    .lb-prev { left: 10px; }
    .lb-next { right: 10px; }
  }

  /* cursors managed on the overlay so they never "freeze" */
  .lb, .lb * { cursor: inherit; }
  .lb { cursor: default; }
  .lb.pannable { cursor: grab; }
  .lb.panning  { cursor: grabbing; }
</style>

<script>
(function(){
  const items = (window.__characterLightboxItems || []).filter(Boolean);
  const profileImg = document.getElementById('profile-image');
  if (!profileImg) return;

  const lb         = document.getElementById('lb');
  const stage      = document.getElementById('lb-stage');
  const layer      = document.getElementById('lb-layer');
  const imgEl      = document.getElementById('lb-img');
  const captionEl  = document.getElementById('lb-caption');
  const spinner    = document.getElementById('lb-spinner');

  const btnClose   = lb.querySelector('.lb-close');
  const btnPrev    = lb.querySelector('.lb-prev');
  const btnNext    = lb.querySelector('.lb-next');

  let index = 0;
  let scale = 1;
  const minScale = 1, maxScale = 6;
  let tx = 0, ty = 0;
  let panning = false, startX = 0, startY = 0;

  function setVisible(vis) {
    lb.setAttribute('aria-hidden', vis ? 'false' : 'true');
    document.body.style.overflow = vis ? 'hidden' : '';
    document.documentElement.style.overscrollBehavior = vis ? 'none' : '';
  }
  function updateCursor(){ if (scale > 1) lb.classList.add('pannable'); else lb.classList.remove('pannable'); }
  function applyTransform(){ layer.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`; }

  function clampPan() {
    const rect = stage.getBoundingClientRect();
    const iw = imgEl.naturalWidth || 1, ih = imgEl.naturalHeight || 1;
    const stageW = rect.width, stageH = rect.height;
    const imgAspect = iw/ih, stageAspect = stageW/stageH;
    let baseW, baseH;
    if (imgAspect > stageAspect) { baseW = stageW; baseH = stageW / imgAspect; }
    else { baseH = stageH; baseW = stageH * imgAspect; }
    const dispW = baseW * scale, dispH = baseH * scale;
    const maxX = Math.max(0, (dispW - stageW) / 2);
    const maxY = Math.max(0, (dispH - stageH) / 2);
    tx = Math.min(maxX, Math.max(-maxX, tx));
    ty = Math.min(maxY, Math.max(-maxY, ty));
  }

  function zoomAt(clientX, clientY, factor) {
    const prev = scale;
    scale = Math.max(minScale, Math.min(maxScale, scale * factor));
    if (scale === prev) return;
    const rect = stage.getBoundingClientRect();
    const cx = clientX - rect.left - rect.width / 2;
    const cy = clientY - rect.top  - rect.height / 2;
    tx = tx - cx * (scale/prev - 1);
    ty = ty - cy * (scale/prev - 1);
    clampPan(); applyTransform(); updateCursor();
  }
  function fitBase(){ scale = 1; tx = 0; ty = 0; applyTransform(); updateCursor(); }

  function loadAt(i){
    index = ((i % items.length) + items.length) % items.length;
    const it = items[index];
    spinner.setAttribute('aria-hidden','false'); imgEl.style.opacity = '0';

    const probe = new Image();
    probe.onload = () => {
      imgEl.src = it.src; imgEl.alt = it.alt || ''; captionEl.textContent = it.alt || '';
      spinner.setAttribute('aria-hidden','true'); imgEl.style.opacity = '1';
      fitBase();  // fits into the fixed stage; tall images get side space automatically
    };
    probe.onerror = () => { spinner.setAttribute('aria-hidden','true'); captionEl.textContent = 'Failed to load image'; };
    probe.src = it.src;
  }

  function openAt(i){ if (!items.length) return; setVisible(true); loadAt(i); }
  function close(){ setVisible(false); imgEl.src=''; }

  function prev(){ loadAt(index - 1); }
  function next(){ loadAt(index + 1); }

  if (items.length) profileImg.addEventListener('click', () => openAt(0));

  btnClose?.addEventListener('click', close);
  btnPrev ?.addEventListener('click', prev);
  btnNext ?.addEventListener('click', next);
  lb.addEventListener('click', (e) => { if (e.target.classList.contains('lb-backdrop')) close(); });

  // keyboard
  document.addEventListener('keydown', (e) => {
    if (lb.getAttribute('aria-hidden') === 'true') return;
    if (e.key === 'Escape') close();
    else if (e.key === 'ArrowLeft') prev();
    else if (e.key === 'ArrowRight') next();
    else if (e.key === '+') zoomAt(window.innerWidth/2, window.innerHeight/2, 1.15);
    else if (e.key === '-') zoomAt(window.innerWidth/2, window.innerHeight/2, 1/1.15);
    else if (e.key === '0') fitBase();
  });

  // wheel zoom
  stage.addEventListener('wheel', (e) => {
    if (lb.getAttribute('aria-hidden') === 'true') return;
    e.preventDefault();
    zoomAt(e.clientX, e.clientY, e.deltaY > 0 ? 1/1.15 : 1.15);
  }, { passive: false });

  // pan while zoomed
  stage.addEventListener('pointerdown', (e) => {
    if (scale <= 1) return;
    e.preventDefault();
    panning = true; lb.classList.add('panning');
    startX = e.clientX - tx; startY = e.clientY - ty;
    stage.setPointerCapture(e.pointerId);
  });
  stage.addEventListener('pointermove', (e) => {
    if (!panning) return;
    e.preventDefault();
    tx = e.clientX - startX; ty = e.clientY - startY;
    clampPan(); applyTransform();
  });
  function endPan(e){ if (!panning) return; panning = false; lb.classList.remove('panning'); try { stage.releasePointerCapture(e.pointerId); } catch(_) {} }
  stage.addEventListener('pointerup', endPan);
  stage.addEventListener('pointercancel', endPan);

  // double click / tap toggle
  let lastTap = 0;
  stage.addEventListener('dblclick', (e) => { e.preventDefault(); if (scale === 1) zoomAt(e.clientX, e.clientY, 2.0); else fitBase(); });
  stage.addEventListener('touchend', (e) => { const now = Date.now(); if (now - lastTap < 300) { const t = e.changedTouches[0]; if (scale === 1) zoomAt(t.clientX, t.clientY, 2.0); else fitBase(); } lastTap = now; }, { passive: true });

  // resize: keep centered/clamped in the fixed stage
  window.addEventListener('resize', () => { if (lb.getAttribute('aria-hidden') === 'true') return; if (scale === 1) fitBase(); else { clampPan(); applyTransform(); } });
})();
</script>
