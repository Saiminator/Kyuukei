---
layout: default
---

<div class="character-detail">
  <!-- Back Button Container for Centering -->
  <div class="back-btn-container" style="text-align: center; margin-bottom: 1rem;">
    <button class="back-select-btn" onclick="window.history.back();">
      Back to Character Selection
    </button>
  </div>
  
  <div class="detail-container">
    <!-- Left Panel: Character Background/Abilities -->
    <div class="left-panel">
      {{ content }}
    </div>

    <!-- Right Panel: Character Image and Basic Info -->
    <div class="right-panel">
      <div class="image-container">
        <!-- Clickable profile image (opens lightbox if gallery exists; PFP is NOT in the slideshow) -->
        <img id="profile-image"
             src="{{ page.image | relative_url }}"
             alt="{{ page.title | escape }}"
             style="cursor: zoom-in; max-width: 100%; height: auto;">
      </div>

      <div class="basic-info">
        {% if page.age %}<p><strong>Age:</strong> {{ page.age }}</p>{% endif %}
        {% if page.birthday %}<p><strong>Birthday:</strong> {{ page.birthday }}</p>{% endif %}
        {% if page.species %}<p><strong>Species:</strong> {{ page.species }}</p>{% endif %}
        {% if page.gender %}<p><strong>Gender:</strong> {{ page.gender }}</p>{% endif %}
        {% if page.height %}<p><strong>Height:</strong> {{ page.height }}</p>{% endif %}
        {% if page.weight %}<p><strong>Weight:</strong> {{ page.weight }}</p>{% endif %}
        {% if page.cup_size %}<p><strong>Cup Size:</strong> {{ page.cup_size }}</p>{% endif %}
        {% if page.mana_color %}<p><strong>Mana Color:</strong> {{ page.mana_color }}</p>{% endif %}
        {% if page.hair_color %}<p><strong>Hair color:</strong> {{ page.hair_color }}</p>{% endif %}
        {% if page.eye_color %}<p><strong>Eye color:</strong> {{ page.eye_color }}</p>{% endif %}
        {% if page.credit %}<p><strong>Picture Credit:</strong> {{ page.credit }}</p>{% endif %}
      </div>
    </div>
  </div>
</div>

{%- comment -%}
Lightbox items come ONLY from page.gallery (profile image is not included).
Supports short form (string) and object form {src, alt}.
{%- endcomment -%}
{% assign gallery = page.gallery %}
<script>
  // Build items from gallery only (no profile image)
  window.__characterLightboxItems = [
    {% if gallery and gallery.size > 0 %}
      {% for item in gallery %}
        {
          {% if item.src %}
            "src": "{{ item.src | relative_url }}",
            "alt": {{ (item.alt | default: page.title) | jsonify }}
          {% else %}
            "src": "{{ item | relative_url }}",
            "alt": {{ page.title | jsonify }}
          {% endif %}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    {% endif %}
  ];
</script>

<!-- LIGHTBOX MARKUP -->
<div id="lb" class="lb" aria-hidden="true">
  <div class="lb-backdrop" data-close></div>

  <figure class="lb-content" role="dialog" aria-modal="true" aria-label="Image viewer" tabindex="-1">
    <div class="lb-stage">
      <div class="lb-spinner" id="lb-spinner" aria-hidden="true"></div>
      <img id="lb-img" src="" alt="" />
    </div>
    <figcaption id="lb-caption"></figcaption>

    <button class="lb-btn lb-close" data-close aria-label="Close">&times;</button>
    <button class="lb-btn lb-prev" data-prev aria-label="Previous">&#10094;</button>
    <button class="lb-btn lb-next" data-next aria-label="Next">&#10095;</button>
  </figure>
</div>

<style>
  /* Global safety: keep padding inside size calcs & prevent image inline gaps */
  .lb, .lb * { box-sizing: border-box; }
  #lb-img { margin: 0 auto; }

  .lb { position: fixed; inset: 0; display: none; z-index: 1000; }
  .lb[aria-hidden="false"] { display: block; }

  .lb-backdrop {
    position: absolute; inset: 0;
    background: rgba(0,0,0,.70);
    backdrop-filter: blur(2px);
  }

  /* ====== DESKTOP / LARGE ====== */
  .lb-content {
    position: absolute;
    left: 50%; top: 50%;
    transform: translate(-50%, -50%);
    max-width: min(98vw, 1400px);
    max-height: 96vh;
    display: grid;
    grid-template-rows: 1fr auto;
    gap: .5rem;
    z-index: 1;
    outline: none;
  }

  .lb-stage {
    position: relative;
    width: 100%;
    height: auto;
    display: grid; place-items: center;
    background: rgba(0,0,0,.25);
    border-radius: .6rem;
    box-shadow: 0 16px 40px rgba(0,0,0,.45);
    overflow: hidden;
  }

  #lb-img {
    display: block;
    max-width: 98vw;
    max-height: 90vh;
    object-fit: contain;
    opacity: 0;
    transition: opacity .15s ease;
    /* === additions to make zoom/pan behave nicely === */
    user-select: none;           /* no selection flash */
    -webkit-user-drag: none;     /* prevent native drag image ghost */
    will-change: transform;
    transform: translate(0px, 0px) scale(1);
    transform-origin: center center;
    cursor: default;
  }

  #lb-caption {
    color: #fff;
    text-align: center;
    font-size: .95rem;
    min-height: 1.2em;
  }

  .lb-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0,0,0,.55);
    color: #fff;
    border: none;
    width: 48px; height: 48px;
    border-radius: 999px;
    display: grid; place-items: center;
    font-size: 22px;
    cursor: pointer;
    transition: background .15s ease;
    z-index: 2;
  }
  .lb-btn:hover { background: rgba(0,0,0,.8); }

  .lb-close {
    top: -20px; right: -20px; transform: none;
    width: 40px; height: 40px; font-size: 28px;
    background: rgba(0,0,0,.7);
  }
  .lb-prev { left: -64px; }
  .lb-next { right: -64px; }

  .lb-spinner {
    position: absolute; inset: 0;
    display: grid; place-items: center;
    background: transparent;
  }
  .lb-spinner::after {
    content: "";
    width: 38px; height: 38px;
    border-radius: 999px;
    border: 3px solid rgba(255,255,255,.35);
    border-top-color: #fff;
    animation: lbspin 0.8s linear infinite;
  }
  [aria-hidden="true"] > .lb-spinner,
  .lb-spinner[aria-hidden="true"] { display: none; }
  @keyframes lbspin { to { transform: rotate(360deg); } }

  /* ====== MOBILE OVERRIDES ====== */
  @media (max-width: 720px) {
    /* Fullscreen modal that includes padding INSIDE its width/height */
    .lb-content {
      position: fixed;
      inset: 0;
      transform: none;
      width: 100dvw;
      height: 100dvh;
      max-width: 100dvw;
      max-height: 100dvh;
      padding:
        calc(env(safe-area-inset-top, 0px) + 10px)
        12px
        calc(env(safe-area-inset-bottom, 0px) + 12px);
      box-sizing: border-box;   /* padding inside box => no overflow */
      display: flex;            /* robust centering */
      flex-direction: column;
      gap: 8px;
      margin: 0 auto;
    }

    .lb-stage {
      flex: 1 1 auto;
      width: 100%;
      height: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0;
      box-shadow: none;
      background: rgba(0,0,0,.15);
      overflow: hidden;         /* never spill horizontally */
    }

    #lb-img {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
    }

    #lb-caption {
      padding: 4px 2px 0;
      font-size: .95rem;
      text-align: center;
    }

    /* Larger, inside-edge buttons for touch */
    .lb-btn {
      width: 56px; height: 56px;
      font-size: 24px;
      background: rgba(0,0,0,.55);
    }
    .lb-prev { left: 10px; top: 50%; transform: translateY(-50%); }
    .lb-next { right: 10px; top: 50%; transform: translateY(-50%); }

    /* Close sits in the safe area (status bar notch safe) */
    .lb-close {
      position: absolute;
      top: calc(env(safe-area-inset-top, 0px) + 8px);
      right: 10px;
      width: 44px; height: 44px;
      font-size: 28px;
      transform: none;
      background: rgba(0,0,0,.7);
      border-radius: 999px;
    }
  }
</style>

<script>
(function(){
  const items = (window.__characterLightboxItems || []).filter(Boolean);
  const profileImg = document.getElementById('profile-image');
  if (!profileImg) return;

  const lb         = document.getElementById('lb');
  const stage      = lb.querySelector('.lb-stage');
  const imgEl      = document.getElementById('lb-img');
  const captionEl  = document.getElementById('lb-caption');
  const spinner    = document.getElementById('lb-spinner');

  const btnCloseEls = lb.querySelectorAll('[data-close]');
  const btnPrev     = lb.querySelector('[data-prev]');
  const btnNext     = lb.querySelector('[data-next]');

  let index = 0;

  function setAriaVisible(vis) {
    lb.setAttribute('aria-hidden', vis ? 'false' : 'true');
    document.body.style.overflow = vis ? 'hidden' : '';
    if (vis) document.documentElement.style.overscrollBehavior = 'none';
    else document.documentElement.style.overscrollBehavior = '';
  }

  function loadAt(i){
    index = ((i % items.length) + items.length) % items.length;
    const it = items[index];

    spinner.setAttribute('aria-hidden','false');
    imgEl.style.opacity = '0';

    const img = new Image();
    img.onload = () => {
      imgEl.src = it.src;
      imgEl.alt = it.alt || '';
      captionEl.textContent = it.alt || '';
      spinner.setAttribute('aria-hidden','true');
      requestAnimationFrame(() => { imgEl.style.opacity = '1'; });
      // reset zoom/pan when a new image loads
      scale = 1; tx = 0; ty = 0; applyTransform();
    };
    img.onerror = () => {
      spinner.setAttribute('aria-hidden','true');
      captionEl.textContent = 'Failed to load image';
    };
    img.src = it.src;
  }

  function openAt(i){
    if (!items.length) return; // no gallery => do nothing
    setAriaVisible(true);
    loadAt(i);
    lb.querySelector('.lb-content')?.focus();
  }
  function close(){
    setAriaVisible(false);
    imgEl.src = '';
  }
  function prev(){ loadAt(index - 1); }
  function next(){ loadAt(index + 1); }

  // Click profile image â†’ open at first gallery image (index 0)
  profileImg.addEventListener('click', () => openAt(0));

  // Controls
  btnPrev?.addEventListener('click', prev);
  btnNext?.addEventListener('click', next);
  btnCloseEls.forEach(b => b.addEventListener('click', close));

  // Backdrop click to close
  lb.addEventListener('click', (e) => {
    if (e.target.classList.contains('lb-backdrop')) close();
  });

  // Keyboard: Esc/Left/Right
  document.addEventListener('keydown', (e) => {
    if (lb.getAttribute('aria-hidden') === 'true') return;
    if (e.key === 'Escape') { e.preventDefault(); close(); }
    else if (e.key === 'ArrowLeft') { e.preventDefault(); prev(); }
    else if (e.key === 'ArrowRight') { e.preventDefault(); next(); }
  });

  // ==== SCROLL-TO-ZOOM + DRAG-TO-PAN (added) ====
  let scale = 1, tx = 0, ty = 0;
  const minScale = 1, maxScale = 6;
  let panning = false, startX = 0, startY = 0;

  function applyTransform() {
    imgEl.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
    imgEl.style.cursor = scale > 1 ? 'grab' : 'default';
  }

  function clampPan() {
    // keep the zoomed image within the stage bounds
    const rect = stage.getBoundingClientRect();
    const iw = imgEl.naturalWidth || 1;
    const ih = imgEl.naturalHeight || 1;
    const stageW = rect.width, stageH = rect.height;
    const fitScale = Math.min(stageW / iw, stageH / ih);
    const dispW = iw * fitScale * scale;
    const dispH = ih * fitScale * scale;
    const maxX = Math.max(0, (dispW - stageW) / 2);
    const maxY = Math.max(0, (dispH - stageH) / 2);
    tx = Math.min(maxX, Math.max(-maxX, tx));
    ty = Math.min(maxY, Math.max(-maxY, ty));
  }

  function zoomAt(clientX, clientY, factor) {
    const prev = scale;
    scale = Math.max(minScale, Math.min(maxScale, scale * factor));
    if (scale === prev) return;

    // keep cursor point fixed while zooming
    const rect = stage.getBoundingClientRect();
    const cx = clientX - rect.left - rect.width / 2;
    const cy = clientY - rect.top  - rect.height / 2;
    tx = tx - cx * (scale/prev - 1);
    ty = ty - cy * (scale/prev - 1);

    clampPan();
    applyTransform();
  }

  // wheel zoom (trackpad/mouse)
  stage.addEventListener('wheel', (e) => {
    if (lb.getAttribute('aria-hidden') === 'true') return;
    e.preventDefault();
    const factor = e.deltaY > 0 ? (1/1.15) : 1.15;
    zoomAt(e.clientX, e.clientY, factor);
  }, { passive: false });

  // drag to pan when zoomed
  stage.addEventListener('pointerdown', (e) => {
    if (scale <= 1) return; // only pan if zoomed
    e.preventDefault();
    panning = true;
    startX = e.clientX - tx; startY = e.clientY - ty;
    imgEl.style.cursor = 'grabbing';
    stage.setPointerCapture(e.pointerId);
  });
  stage.addEventListener('pointermove', (e) => {
    if (!panning) return;
    e.preventDefault();
    tx = e.clientX - startX; ty = e.clientY - startY;
    clampPan(); applyTransform();
  });
  function endPan(e){
    if (!panning) return;
    panning = false;
    imgEl.style.cursor = 'grab';
    try { stage.releasePointerCapture(e.pointerId); } catch(_) {}
  }
  stage.addEventListener('pointerup', endPan);
  stage.addEventListener('pointercancel', endPan);
})();
</script>
