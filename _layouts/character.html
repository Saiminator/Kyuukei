---
layout: default
title: {{ page.title }}
---

<!-- Character Page Template -->
<main class="character-page">
  <header class="char-header">
    <h1 class="char-name">{{ page.title }}</h1>
    <!-- Profile image (click to open gallery). Not included in slideshow. -->
    <button id="pfp-trigger" class="pfp-trigger" aria-label="Open gallery">
      <img id="pfp" src="{{ page.image | default: '/assets/img/placeholder.png' }}" alt="{{ page.title }} profile picture" />
    </button>
  </header>

  <article class="char-body">
    {{ content }}
  </article>
</main>

<!-- Lightspace (modal lightbox) -->
<div id="lb" class="lb-root" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="lb-backdrop" data-close="1" aria-hidden="true"></div>

  <div class="lb-content" tabindex="-1" aria-live="polite">
    <div class="lb-stage">
      <img id="lb-img" alt="Character gallery image" />
      <!-- On-screen controls -->
      <button class="lb-nav lb-prev" aria-label="Previous image" title="Previous (←)">&lsaquo;</button>
      <button class="lb-nav lb-next" aria-label="Next image" title="Next (→)">&rsaquo;</button>

      <div class="lb-zoom-controls">
        <button class="lb-zoom-btn" data-zoom="in" aria-label="Zoom in" title="Zoom in (+)">+</button>
        <button class="lb-zoom-btn" data-zoom="out" aria-label="Zoom out" title="Zoom out (-)">−</button>
        <button class="lb-zoom-btn" data-zoom="reset" aria-label="Reset zoom" title="Reset zoom (0)">⟲</button>
      </div>
    </div>

    <div class="lb-footer">
      <div class="lb-counter"><span id="lb-index">1</span>/<span id="lb-total">1</span></div>
      <button class="lb-close" aria-label="Close (Esc)" title="Close (Esc)">Close</button>
    </div>
  </div>
</div>

<style>
/* ===== Base page bits (scoped) ===== */
.character-page {
  max-width: 1100px;
  margin: 0 auto;
  padding: 1.25rem;
}
.char-header {
  display: grid;
  grid-template-columns: auto 160px;
  align-items: center;
  gap: 1rem;
}
.char-name { margin: 0; }
.pfp-trigger {
  border: 0;
  padding: 0;
  background: none;
  cursor: zoom-in;
  border-radius: .5rem;
  overflow: hidden;
  box-shadow: 0 6px 16px rgba(0,0,0,.15);
}
.pfp-trigger img {
  display: block;
  width: 160px;
  height: 160px;
  object-fit: cover;
}

/* ===== Lightspace (modal) ===== */
.lb-root {
  position: fixed;
  inset: 0;
  display: none;
  z-index: 1000;
}
.lb-root[aria-hidden="false"] { display: block; }

.lb-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,.6);
  backdrop-filter: blur(2px);
}

.lb-content {
  position: absolute;
  left: 50%; top: 50%;
  transform: translate(-50%, -50%);
  /* Consistent size per request */
  width: 60vw;
  height: 80vh;
  max-width: 60vw;
  max-height: 80vh;

  display: grid;
  grid-template-rows: 1fr auto;
  gap: .5rem;
  z-index: 1;
  outline: none;
}

.lb-stage {
  position: relative;
  width: 100%;
  height: 100%;
  display: grid;
  place-items: center;
  background: rgba(0,0,0,.25);
  border-radius: .6rem;
  box-shadow: 0 16px 40px rgba(0,0,0,.45);
  overflow: hidden; /* required for panning */
}

#lb-img {
  display: block;
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;       /* FIT (contain) by default */
  transform-origin: center;
  will-change: transform, opacity;
  opacity: 0;
  transition: opacity .15s ease;
}

/* Nav buttons */
.lb-nav {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  width: 44px; height: 44px;
  border-radius: 999px;
  border: none;
  background: rgba(0,0,0,.5);
  color: #fff;
  font-size: 28px;
  line-height: 1;
  display: grid;
  place-items: center;
  cursor: pointer;
  user-select: none;
}
.lb-prev { left: .5rem; }
.lb-next { right: .5rem; }
.lb-nav:hover { background: rgba(0,0,0,.7); }

/* Zoom controls */
.lb-zoom-controls {
  position: absolute;
  right: .6rem;
  bottom: .6rem;
  display: flex;
  gap: .35rem;
}
.lb-zoom-btn {
  border: none;
  border-radius: .5rem;
  padding: .3rem .55rem;
  background: rgba(0,0,0,.55);
  color: #fff;
  font-size: 16px;
  cursor: pointer;
}
.lb-zoom-btn:hover { background: rgba(0,0,0,.75); }

/* Footer */
.lb-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.lb-counter {
  font-size: .95rem;
  color: #ddd;
}
.lb-close {
  border: none;
  border-radius: .5rem;
  padding: .45rem .75rem;
  background: #111;
  color: #fff;
  cursor: pointer;
}
.lb-close:hover { background: #000; }

/* Mobile: fallback to full-screen */
@media (max-width: 768px) {
  .char-header { grid-template-columns: 1fr 120px; }
  .pfp-trigger img { width: 120px; height: 120px; }

  .lb-content {
    width: 96vw;
    height: 86vh;
    max-width: 96vw;
    max-height: 86vh;
  }
}
</style>

<script>
/* ========= GALLERY SETUP =========
  The gallery is driven by page.gallery in the character's front matter:
  gallery:
    - https://kyuukei.s3.../1.png
    - https://...
*/
(function(){
  const gallery = {{ page.gallery | default: '[]' | jsonify }};

  // Elements
  const lb = document.getElementById('lb');
  const pfpBtn = document.getElementById('pfp-trigger');
  const imgEl = document.getElementById('lb-img');
  const stage = lb.querySelector('.lb-stage');
  const prevBtn = lb.querySelector('.lb-prev');
  const nextBtn = lb.querySelector('.lb-next');
  const closeBtn = lb.querySelector('.lb-close');
  const backdrop = lb.querySelector('.lb-backdrop');
  const idxEl = document.getElementById('lb-index');
  const totEl = document.getElementById('lb-total');

  let index = 0;

  function openAt(i=0){
    if (!gallery.length) return;
    index = (i+gallery.length) % gallery.length;
    totEl.textContent = String(gallery.length);
    lb.setAttribute('aria-hidden', 'false');
    document.documentElement.style.overflow = 'hidden'; // lock scroll
    loadCurrent();
    focusTrap();
  }

  function close(){
    lb.setAttribute('aria-hidden', 'true');
    document.documentElement.style.overflow = '';
  }

  function loadCurrent(){
    const url = gallery[index];
    idxEl.textContent = String(index+1);
    imgEl.style.opacity = 0;
    // Reset zoom/pan; onload handler will ensure transform reset as well
    imgEl.src = url;
  }

  function next(){ if (!gallery.length) return; index = (index + 1) % gallery.length; loadCurrent(); }
  function prev(){ if (!gallery.length) return; index = (index - 1 + gallery.length) % gallery.length; loadCurrent(); }

  // Trigger from PFP (do not include PFP in gallery)
  if (pfpBtn) pfpBtn.addEventListener('click', () => openAt(0));

  // Basic controls
  nextBtn.addEventListener('click', next);
  prevBtn.addEventListener('click', prev);
  closeBtn.addEventListener('click', close);
  backdrop.addEventListener('click', (e) => { if (e.target.dataset.close) close(); });

  // Keyboard: arrows, esc (plus handled in zoom script below)
  document.addEventListener('keydown', (e) => {
    if (lb.getAttribute('aria-hidden') === 'true') return;
    if (e.key === 'ArrowRight') { e.preventDefault(); next(); }
    if (e.key === 'ArrowLeft')  { e.preventDefault(); prev(); }
    if (e.key === 'Escape')     { e.preventDefault(); close(); }
  });

  // Simple focus trap inside modal
  function focusTrap(){
    const focusables = lb.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    const first = focusables[0], last = focusables[focusables.length - 1];
    if (first) first.focus();
    lb.addEventListener('keydown', function(e){
      if (e.key !== 'Tab') return;
      if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
      else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
    });
  }

  // Fade in when loaded
  imgEl.addEventListener('load', () => { imgEl.style.opacity = 1; });

  /* ====== Pan + Zoom (FIT by default) ====== */
  let scale = 1, minScale = 1, maxScale = 6;
  let posX = 0, posY = 0;
  let isPanning = false;
  let startX = 0, startY = 0;

  let pinchStartDist = 0;
  let pinchStartScale = 1;
  function dist(a, b){ const dx = a.clientX - b.clientX, dy = a.clientY - b.clientY; return Math.hypot(dx, dy); }

  function applyTransform() {
    imgEl.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
  }
  function resetTransform() {
    scale = 1; posX = 0; posY = 0; applyTransform();
  }
  function clampPan() {
    const rect = stage.getBoundingClientRect();
    const iw = imgEl.naturalWidth || rect.width;
    const ih = imgEl.naturalHeight || rect.height;
    const stageRatio = rect.width / rect.height;
    const imgRatio = iw / ih;

    let fitW, fitH;
    if (imgRatio > stageRatio) { fitW = rect.width; fitH = rect.width / imgRatio; }
    else { fitH = rect.height; fitW = rect.height * imgRatio; }

    const shownW = fitW * scale;
    const shownH = fitH * scale;

    const maxX = Math.max(0, (shownW - rect.width) / 2);
    const maxY = Math.max(0, (shownH - rect.height) / 2);

    posX = Math.min(maxX, Math.max(-maxX, posX));
    posY = Math.min(maxY, Math.max(-maxY, posY));
  }
  function zoomAt(factor, cx, cy) {
    const rect = stage.getBoundingClientRect();
    const prevScale = scale;
    scale = Math.min(maxScale, Math.max(minScale, scale * factor));
    const eff = scale / prevScale;

    const offsetX = (cx ?? (rect.left + rect.width/2)) - (rect.left + rect.width/2);
    const offsetY = (cy ?? (rect.top + rect.height/2)) - (rect.top + rect.height/2);

    posX = (posX - offsetX) * eff + offsetX;
    posY = (posY - offsetY) * eff + offsetY;

    clampPan();
    applyTransform();
  }

  // Reset zoom when new image loads
  imgEl.addEventListener('load', resetTransform);

  // Wheel zoom
  stage.addEventListener('wheel', (e) => {
    if (lb.getAttribute('aria-hidden') === 'true') return;
    e.preventDefault();
    const factor = e.deltaY < 0 ? 1.1 : 1/1.1;
    zoomAt(factor, e.clientX, e.clientY);
  }, { passive: false });

  // Drag to pan
  stage.addEventListener('mousedown', (e) => {
    if (lb.getAttribute('aria-hidden') === 'true') return;
    isPanning = true;
    startX = e.clientX - posX;
    startY = e.clientY - posY;
    stage.style.cursor = (scale > 1) ? 'grabbing' : 'default';
  });
  window.addEventListener('mousemove', (e) => {
    if (!isPanning) return;
    posX = e.clientX - startX;
    posY = e.clientY - startY;
    clampPan();
    applyTransform();
  });
  window.addEventListener('mouseup', () => {
    isPanning = false;
    stage.style.cursor = '';
  });

  // Double-click toggle zoom
  stage.addEventListener('dblclick', (e) => {
    if (scale === 1) zoomAt(2, e.clientX, e.clientY);
    else { resetTransform(); }
  });

  // Touch pan/pinch
  stage.addEventListener('touchstart', (e) => {
    if (lb.getAttribute('aria-hidden') === 'true') return;
    if (e.touches.length === 1) {
      isPanning = true;
      startX = e.touches[0].clientX - posX;
      startY = e.touches[0].clientY - posY;
    } else if (e.touches.length === 2) {
      isPanning = false;
      pinchStartDist = dist(e.touches[0], e.touches[1]);
      pinchStartScale = scale;
    }
  }, {passive: true});

  stage.addEventListener('touchmove', (e) => {
    if (e.touches.length === 1 && isPanning) {
      posX = e.touches[0].clientX - startX;
      posY = e.touches[0].clientY - startY;
      clampPan();
      applyTransform();
    } else if (e.touches.length === 2) {
      e.preventDefault();
      const d = dist(e.touches[0], e.touches[1]);
      const factor = d / (pinchStartDist || d);
      scale = Math.min(maxScale, Math.max(minScale, pinchStartScale * factor));
      clampPan();
      applyTransform();
    }
  }, {passive: false});

  window.addEventListener('touchend', () => { isPanning = false; }, {passive: true});

  // Keyboard helpers
  document.addEventListener('keydown', (e) => {
    if (lb.getAttribute('aria-hidden') === 'true') return;
    if (e.key === '+') { e.preventDefault(); zoomAt(1.1); }
    if (e.key === '-') { e.preventDefault(); zoomAt(1/1.1); }
    if (e.key === '0') { e.preventDefault(); resetTransform(); }
  });

  // Zoom buttons
  lb.querySelectorAll('.lb-zoom-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const mode = btn.dataset.zoom;
      if (mode === 'in') zoomAt(1.1);
      if (mode === 'out') zoomAt(1/1.1);
      if (mode === 'reset') resetTransform();
    });
  });

})();
</script>
