---
layout: default
---

<div class="character-detail">
  <!-- Back Button Container for Centering -->
  <div class="back-btn-container" style="text-align: center; margin-bottom: 1rem;">
    <button class="back-select-btn" onclick="window.history.back();">
      Back to Character Selection
    </button>
  </div>
  
  <div class="detail-container">
    <!-- Left Panel: Character Background/Abilities -->
    <div class="left-panel">
      {{ content }}
    </div>
    <!-- Right Panel: Character Image and Basic Info -->
    <div class="right-panel">
      <div class="image-container">
        <img src="{{ page.image }}" alt="{{ page.title }}" id="character-pfp" style="cursor: zoom-in;">
      </div>
      <div class="basic-info">
        {% if page.age %}<p><strong>Age:</strong> {{ page.age }}</p>{% endif %}
        {% if page.birthday %}<p><strong>Birthday:</strong> {{ page.birthday }}</p>{% endif %}
        {% if page.species %}<p><strong>Species:</strong> {{ page.species }}</p>{% endif %}
        {% if page.gender %}<p><strong>Gender:</strong> {{ page.gender }}</p>{% endif %}
        {% if page.height %}<p><strong>Height:</strong> {{ page.height }}</p>{% endif %}
        {% if page.weight %}<p><strong>Weight:</strong> {{ page.weight }}</p>{% endif %}
        {% if page.cup_size %}<p><strong>Cup Size:</strong> {{ page.cup_size }}</p>{% endif %}
        {% if page.mana_color %}<p><strong>Mana Color:</strong> {{ page.mana_color }}</p>{% endif %}
        {% if page.hair_color %}<p><strong>Hair color:</strong> {{ page.hair_color }}</p>{% endif %}
        {% if page.eye_color %}<p><strong>Eye color:</strong> {{ page.eye_color }}</p>{% endif %}
        {% if page.credit %}<p><strong>Picture Credit:</strong> {{ page.credit }}</p>{% endif %}
      </div>
    </div>
  </div>
</div>

<!-- ========================= -->
<!-- Gallery Lightbox Overlay  -->
<!-- ========================= -->
<div class="gallery-overlay" aria-hidden="true" style="display:none;">
  <div class="gallery-backdrop"></div>
  <div class="gallery-modal" role="dialog" aria-modal="true" aria-label="Image gallery">
    <button class="gallery-btn gallery-close" aria-label="Close (Esc)">&times;</button>

    <div class="gallery-stage">
      <div class="gallery-viewport">
        <img class="gallery-image" alt="">
      </div>
      <!-- UI Controls -->
      <div class="gallery-controls">
        <button class="gallery-btn gallery-prev" aria-label="Previous (←)">&#10094;</button>
        <div class="gallery-zoom">
          <button class="gallery-btn gallery-zoom-out" aria-label="Zoom out">−</button>
          <button class="gallery-btn gallery-zoom-reset" aria-label="Reset zoom">1:1</button>
          <button class="gallery-btn gallery-zoom-in" aria-label="Zoom in">+</button>
        </div>
        <button class="gallery-btn gallery-next" aria-label="Next (→)">&#10095;</button>
      </div>
      <div class="gallery-counter" aria-live="polite"></div>
    </div>
  </div>
</div>

<style>
  /* ===== Lightbox Base (scoped) ===== */
  .gallery-overlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
  }
  .gallery-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.7);
  }
  .gallery-modal {
    position: absolute;
    inset: 0;
    display: grid;
    place-items: center;
    pointer-events: none; /* allow clicks to pass unless on children */
  }

  .gallery-stage {
    width: 60vw;   /* 60% of screen width */
    height: 80vh;  /* 80% of screen height */
    background: #111;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    position: relative;
    overflow: hidden;
    pointer-events: auto; /* re-enable inside modal */
  }

  /* Close button */
  .gallery-close {
    position: absolute;
    top: 12px;
    right: 16px;
    font-size: 28px;
    line-height: 1;
    background: rgba(0,0,0,0.45);
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 6px 10px;
    cursor: pointer;
    z-index: 2;
  }

  /* Viewport keeps consistent size, image fits (no crop) */
  .gallery-viewport {
    position: absolute;
    inset: 48px 0 56px 0; /* leave room for controls/counter */
    display: grid;
    place-items: center;
    overflow: hidden; /* for panning bounds */
    touch-action: none; /* for better pointer handling */
  }
  .gallery-image {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    user-select: none;
    will-change: transform;
    transform-origin: center center;
    /* IMPORTANT: Fit by default; never crop */
    object-fit: contain; /* (safe with explicit width/height auto) */
    pointer-events: none; /* image itself won’t intercept events; container handles drag */
  }

  /* Controls */
  .gallery-controls {
    position: absolute;
    left: 0;
    right: 0;
    bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 10px;
    gap: 10px;
  }
  .gallery-btn {
    background: rgba(0,0,0,0.5);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.25);
    border-radius: 8px;
    padding: 8px 12px;
    cursor: pointer;
    transition: background 0.15s ease;
  }
  .gallery-btn:hover { background: rgba(0,0,0,0.7); }

  .gallery-prev, .gallery-next {
    font-size: 18px;
    min-width: 44px;
  }

  .gallery-zoom {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .gallery-counter {
    position: absolute;
    top: 12px;
    left: 16px;
    color: #fff;
    font-size: 14px;
    background: rgba(0,0,0,0.45);
    padding: 4px 8px;
    border-radius: 6px;
  }

  /* Make sure nothing outside gets affected */
  .character-detail .right-panel .image-container img#character-pfp { display: block; }
</style>

<script>
(function(){
  // Pull gallery URLs from front matter
  const GALLERY = ({% if page.gallery and page.gallery.size > 0 %}[{% for url in page.gallery %}"{{ url | escape }}"{% unless forloop.last %},{% endunless %}{% endfor %}]{% else %}[] {% endif %});

  // Early exit if no gallery defined
  if (!GALLERY.length) return;

  // Elements
  const pfp = document.getElementById('character-pfp');
  const overlay = document.querySelector('.gallery-overlay');
  const stage = document.querySelector('.gallery-stage');
  const viewport = document.querySelector('.gallery-viewport');
  const img = document.querySelector('.gallery-image');
  const btnClose = document.querySelector('.gallery-close');
  const btnPrev = document.querySelector('.gallery-prev');
  const btnNext = document.querySelector('.gallery-next');
  const btnZoomIn = document.querySelector('.gallery-zoom-in');
  const btnZoomOut = document.querySelector('.gallery-zoom-out');
  const btnZoomReset = document.querySelector('.gallery-zoom-reset');
  const counter = document.querySelector('.gallery-counter');

  let index = 0;
  let scale = 1;
  let minScale = 1;
  let maxScale = 6;
  let pos = { x: 0, y: 0 };
  let isPanning = false;
  let start = { x: 0, y: 0 };

  function updateCounter(){
    counter.textContent = (index + 1) + ' / ' + GALLERY.length;
  }

  function loadImage(i){
    index = (i + GALLERY.length) % GALLERY.length;
    img.src = GALLERY[index];
    img.onload = function(){
      // Reset zoom and pan on image change
      scale = 1;
      pos.x = 0;
      pos.y = 0;
      applyTransform();
      updateCounter();
    };
  }

  function openOverlay(startIndex=0){
    overlay.style.display = 'block';
    overlay.setAttribute('aria-hidden','false');
    loadImage(startIndex);
    // Trap focus to modal (simple)
    btnClose.focus();
    // Prevent page scroll while open
    document.documentElement.style.overflow = 'hidden';
  }

  function closeOverlay(){
    overlay.style.display = 'none';
    overlay.setAttribute('aria-hidden','true');
    document.documentElement.style.overflow = '';
  }

  function applyTransform(){
    img.style.transform = `translate(${pos.x}px, ${pos.y}px) scale(${scale})`;
  }

  function clampPan(){
    // Constrain panning so image never disappears completely
    const rect = viewport.getBoundingClientRect();
    const imgW = img.naturalWidth;
    const imgH = img.naturalHeight;

    // Compute displayed size at current scale (fit by default)
    const fitScale = Math.min(rect.width / imgW, rect.height / imgH);
    const displayedW = imgW * fitScale * scale;
    const displayedH = imgH * fitScale * scale;

    const limitX = Math.max(0, (displayedW - rect.width) / 2);
    const limitY = Math.max(0, (displayedH - rect.height) / 2);

    pos.x = Math.min(limitX, Math.max(-limitX, pos.x));
    pos.y = Math.min(limitY, Math.max(-limitY, pos.y));
  }

  function zoomAt(delta, clientX, clientY){
    const rect = viewport.getBoundingClientRect();
    const prevScale = scale;
    scale = Math.min(maxScale, Math.max(minScale, scale * (delta > 0 ? 1.1 : 0.9)));

    // Keep the point under the cursor stable while zooming
    const cx = clientX - rect.left - rect.width / 2 - pos.x;
    const cy = clientY - rect.top - rect.height / 2 - pos.y;
    const ratio = scale / prevScale;
    pos.x -= cx * (ratio - 1);
    pos.y -= cy * (ratio - 1);

    clampPan();
    applyTransform();
  }

  // Event hooks
  pfp.addEventListener('click', () => openOverlay(0));
  btnClose.addEventListener('click', closeOverlay);
  overlay.querySelector('.gallery-backdrop').addEventListener('click', closeOverlay);

  btnPrev.addEventListener('click', () => loadImage(index - 1));
  btnNext.addEventListener('click', () => loadImage(index + 1));
  btnZoomIn.addEventListener('click', () => { scale = Math.min(maxScale, scale * 1.2); clampPan(); applyTransform(); });
  btnZoomOut.addEventListener('click', () => { scale = Math.max(minScale, scale / 1.2); clampPan(); applyTransform(); });
  btnZoomReset.addEventListener('click', () => { scale = 1; pos.x = 0; pos.y = 0; applyTransform(); });

  // Keyboard controls
  window.addEventListener('keydown', (e) => {
    if (overlay.getAttribute('aria-hidden') === 'true') return;
    if (e.key === 'Escape') closeOverlay();
    if (e.key === 'ArrowLeft') loadImage(index - 1);
    if (e.key === 'ArrowRight') loadImage(index + 1);
  });

  // Pan handlers (mouse + touch)
  function pointerDown(e){
    isPanning = true;
    viewport.setPointerCapture ? viewport.setPointerCapture(e.pointerId || 1) : null;
    start.x = (e.clientX ?? (e.touches && e.touches[0].clientX)) - pos.x;
    start.y = (e.clientY ?? (e.touches && e.touches[0].clientY)) - pos.y;
  }
  function pointerMove(e){
    if (!isPanning) return;
    const clientX = e.clientX ?? (e.touches && e.touches[0].clientX);
    const clientY = e.clientY ?? (e.touches && e.touches[0].clientY);
    pos.x = clientX - start.x;
    pos.y = clientY - start.y;
    clampPan();
    applyTransform();
  }
  function pointerUp(){
    isPanning = false;
  }

  // Mouse
  viewport.addEventListener('mousedown', (e) => { if (scale > 1) pointerDown(e); });
  window.addEventListener('mousemove', pointerMove);
  window.addEventListener('mouseup', pointerUp);

  // Touch
  viewport.addEventListener('touchstart', (e) => { if (scale > 1) pointerDown(e); }, {passive:false});
  window.addEventListener('touchmove', (e) => { if (isPanning) { e.preventDefault(); pointerMove(e); } }, {passive:false});
  window.addEventListener('touchend', pointerUp);

  // Wheel zoom (fit by default, never crop)
  viewport.addEventListener('wheel', (e) => {
    e.preventDefault();
    zoomAt(e.deltaY, e.clientX, e.clientY);
  }, { passive: false });

})();
</script>
